name: Daily QA Report Generation

on:
  schedule:
    # Ejecutar diariamente a las 9:00 AM UTC (ajustar seg√∫n zona horaria)
    - cron: '0 9 * * *'
  
  # Permitir ejecuci√≥n manual para testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Ejecutar en modo dry-run (sin guardar cambios)'
        required: false
        default: 'false'
        type: boolean
      project_filter:
        description: 'Filtros de proyecto (separados por coma)'
        required: false
        type: string
      include_csv:
        description: 'Incluir archivos CSV'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-qa-reports:
    name: Generate QA Reports
    runs-on: ubuntu-latest
    
    # Permisos m√≠nimos necesarios para OIDC
    permissions:
      id-token: write      # Para asumir rol AWS via OIDC
      contents: read       # Para checkout del c√≥digo
      actions: write       # Para artifacts (opcional)
      
    # Variables de entorno desde GitHub Variables (no secrets)
    env:
      NOTION_PROJECTS_DB_ID: ${{ vars.NOTION_PROJECTS_DB_ID }}
      MATRIZ_DB_NAME: ${{ vars.MATRIZ_DB_NAME }}
      INCIDENCIAS_DB_NAME: ${{ vars.INCIDENCIAS_DB_NAME }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_SECRETS_NAME: ${{ vars.AWS_SECRETS_NAME }}
      AWS_S3_BUCKET: ${{ vars.AWS_S3_BUCKET }}
      AWS_S3_KMS_KEY_ID: ${{ vars.AWS_S3_KMS_KEY_ID }}
      
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: üîß Install dependencies
        run: npm ci
        
      - name: üèóÔ∏è Build TypeScript
        run: npm run build
        
      - name: üß™ Run tests
        run: npm test
        continue-on-error: false
        
      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-QAReports
          
      - name: ‚úÖ Validate configuration
        run: npm start validate
        
      - name: üìä Generate QA Reports
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "üîç Ejecutando en modo dry-run..."
            npm start -- --dry-run
          else
            echo "üöÄ Generando reportes..."
            
            # Construir comando con opciones
            CMD="npm start --"
            
            if [[ -n "${{ github.event.inputs.project_filter }}" ]]; then
              IFS=',' read -ra PROJECTS <<< "${{ github.event.inputs.project_filter }}"
              for project in "${PROJECTS[@]}"; do
                CMD="$CMD --project \"$project\""
              done
            fi
            
            if [[ "${{ github.event.inputs.include_csv }}" == "true" ]]; then
              CMD="$CMD --csv"
            fi
            
            echo "Ejecutando: $CMD"
            eval $CMD
          fi
          
      - name: üìã Upload report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports-${{ github.run_number }}
          path: |
            reports/
            snapshots/
          retention-days: 30
          
      - name: üìà Generate job summary
        if: always()
        run: |
          echo "## üìä QA Report Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Modo:** ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Producci√≥n' }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ -n "${{ github.event.inputs.project_filter }}" ]]; then
            echo "- **Filtros:** ${{ github.event.inputs.project_filter }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Estado de la Ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ **√âxito:** Reportes generados correctamente" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ job.status }}" == "failure" ]]; then
            echo "‚ùå **Error:** Fall√≥ la generaci√≥n de reportes" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Parcial:** Ejecuci√≥n completada con advertencias" >> $GITHUB_STEP_SUMMARY
          fi
          
  # Job de notificaci√≥n en caso de fallo
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: generate-qa-reports
    if: failure()
    
    steps:
      - name: üö® Send failure notification
        run: |
          echo "‚ùå La generaci√≥n de reportes QA fall√≥"
          echo "Ver detalles en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Aqu√≠ puedes agregar notificaciones a Slack, Teams, etc.
          # Ejemplo para webhook gen√©rico:
          # curl -X POST "$WEBHOOK_URL" \
          #   -H "Content-Type: application/json" \
          #   -d "{\"text\":\"‚ùå QA Report generation failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"


# Configuraci√≥n adicional requerida:

# GitHub Repository Variables (Settings > Secrets and variables > Actions > Variables):
# NOTION_PROJECTS_DB_ID=[160a972d1d9d800b9d9fdc19f16e1126]
# MATRIZ_DB_NAME=[Matriz de Pruebas]  
# INCIDENCIAS_DB_NAME=[Reporte de incidencias]
# AWS_REGION=[us-east-1]
# AWS_ROLE_TO_ASSUME=[arn:aws:iam::ACCOUNT:role/GitHubActions-QAReports]
# AWS_SECRETS_NAME=[notion-qa-token]
# AWS_S3_BUCKET=[reportes-qa-bucket]
# AWS_S3_KMS_KEY_ID=[arn:aws:kms:us-east-1:ACCOUNT:key/KEY-ID]

# Pol√≠tica IAM para el rol AWS (GitHubActions-QAReports):
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Action": [
#         "secretsmanager:GetSecretValue"
#       ],
#       "Resource": "arn:aws:secretsmanager:REGION:ACCOUNT:secret:notion-qa-token*"
#     },
#     {
#       "Effect": "Allow",
#       "Action": [
#         "s3:PutObject",
#         "s3:PutObjectAcl",
#         "s3:GetObject"
#       ],
#       "Resource": "arn:aws:s3:::reportes-qa-bucket/*"
#     },
#     {
#       "Effect": "Allow",
#       "Action": [
#         "kms:Encrypt",
#         "kms:Decrypt",
#         "kms:ReEncrypt*",
#         "kms:GenerateDataKey*",
#         "kms:DescribeKey"
#       ],
#       "Resource": "arn:aws:kms:REGION:ACCOUNT:key/KEY-ID"
#     }
#   ]
# }

# Trust Policy para OIDC:
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Principal": {
#         "Federated": "arn:aws:iam::ACCOUNT:oidc-provider/token.actions.githubusercontent.com"
#       },
#       "Action": "sts:AssumeRoleWithWebIdentity",
#       "Condition": {
#         "StringEquals": {
#           "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
#         },
#         "StringLike": {
#           "token.actions.githubusercontent.com:sub": "repo:OWNER/REPO:*"
#         }
#       }
#     }
#   ]
# }